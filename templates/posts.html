<!DOCTYPE html>
<html>
  <head>
    <title>Bot Provoking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#4c83c4" />
    <meta charset="UTF-8" />
    <style>
      ::selection {
        background: #99d7f5;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: #222;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
          "Helvetica Neue", sans-serif;
        padding-bottom: 4em;
        padding-top: 4em;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        user-select: none;
        line-height: 1;
      }

      a {
        color: inherit;
        text-decoration: inherit;
      }

      .content {
        max-width: 700px;
        margin: auto;
        text-align: initial;
      }

      strong {
        font-weight: 600;
        color: #444;
      }

      .nav {
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 100000;
        left: 0;
        height: 40px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
        padding-right: 10px;
        padding-left: 10px;
        flex-flow: row nowrap;
        background: white;
      }

      .back-button {
        position: absolute;
        height: 20px;
        background: #4c83c4;
        color: #f7f7f7;
        text-transform: uppercase;
        z-index: 100000;
        font-size: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-left: 10px;
        transition: all 0.15s ease;
        padding-right: 10px;
        border-radius: 10px;
        user-select: none;
        cursor: pointer;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
      }

      .ncontainer {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ccc;
        font-weight: 600;
        height: 40px;
        font-size: 14px;
      }

      .right {
        float: right;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        width: 100%;
        margin-left: -10px;
        padding-right: 10px;
        position: absolute;
      }

      p {
        font-size: 15px;
        line-height: 26px;
      }

      .date {
        font-size: 10px;
        color: #4c83c4;
        user-select: none;
      }

      .tags {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-right: 10px;
      }

      .tag {
        background: #4c83c4;
        font-size: 8px;
        color: #f7f7f7;
        display: inline-flex;
        justify-content: center;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
        transition: all 0.15s ease;
        align-items: center;
        padding-left: 10px;
        padding-right: 10px;
        margin-left: 10px;
        cursor: pointer;
        height: 20px;
        border-radius: 10px;
      }

      .back-button:hover {
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.16);
        transform: translateY(-1px);
      }

      .date {
        display: inline-block;
        color: #4c83c4;
      }
      .tags {
        display: inline-block;
      }
      .tag {
        background: #4c83c4;
        font-size: 8px;
        color: #f7f7f7;
        display: inline-flex;
        justify-content: center;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
        transition: all 0.15s ease;
        align-items: center;
        padding-left: 10px;
        padding-right: 10px;
        margin-left: 10px;
        cursor: pointer;
        height: 20px;
        border-radius: 10px;
      }
      .tag:hover {
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.16);
        transform: translateY(-1px);
      }

      h1 {
        font-size: 36px;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 30px;
        margin-block-start: 0.83em;
        margin-block-end: 0.83em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
      }

      h2 {
        font-size: 0.9rem;
        user-select: none;
        font-weight: 600;
        margin-bottom: 0.4rem;
        margin-left: 0.1rem;
        color: #4c83c4;
        margin-block-start: 0em;
        margin-block-end: 0em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
      }
      .post {
        height: 200px;
        padding: 20px;
        margin: 30px;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        position: relative;
        background: #f7f7f7;
      }
      .info {
        font-size: 10px;
        left: 20px;
        position: absolute;
        bottom: 10px;
        width: 100%;
        padding-right: 40px;
        user-select: none;
        text-transform: uppercase;
      }
      .info::before {
        content: "";
        display: block;
        background: white;
        position: absolute;
        left: 0;
        bottom: 29.5px;
        margin-left: -20px;
        height: 1px;
        width: 100%;
      }
      .postcontent {
        flex-grow: 1;
        padding-top: 4px;
      }
      .postcontent p {
        font-size: 0.75em;
        color: #888;
        text-overflow: ellipsis;
        line-height: 19.5px;
      }
      .posttitle {
        font-weight: bold;
        font-size: 1.5em;
        color: #444;
      }
      .posttitle a {
        position: relative;
        display: inline-block;
        text-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
        transition: all 0.15s ease;
      }
      .posttitle a:hover {
        transform: translateY(-1px);
        text-shadow: 0 7px 20px rgba(0, 0, 0, 0.16);
      }
      .posttitle a::after {
        content: "";
        display: block;
        width: 100%;
        margin-top: 2px;
        transition: all 0.15s ease;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
        position: absolute;
        height: 1px;
        background: #4c83c4;
      }
      .posttitle a:hover::after {
        transform: translateY(1px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.16);
      }
      .iright {
        float: right;
      }
      ::-webkit-scrollbar {
        display: none;
      }
      .search {
        z-index: 1000;
        outline: none;
        margin: 0;
        border: none;
        color: #333;
        display: flex;
        justify-content: center;
        text-align: center;
        align-items: center;
        caret-color: #333;
        padding: 0;
        font: inherit;
      }
      .search:placeholder-shown {
        caret-color: transparent;
      }
      .search::placeholder {
        color: #ccc;
      }
      .post.hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <script>
      (function() {
        var FuzzySet = function(
          arr,
          useLevenshtein,
          gramSizeLower,
          gramSizeUpper
        ) {
          var fuzzyset = {};

          // default options
          arr = arr || [];
          fuzzyset.gramSizeLower = gramSizeLower || 2;
          fuzzyset.gramSizeUpper = gramSizeUpper || 3;
          fuzzyset.useLevenshtein =
            typeof useLevenshtein !== "boolean" ? true : useLevenshtein;

          // define all the object functions and attributes
          fuzzyset.exactSet = {};
          fuzzyset.matchDict = {};
          fuzzyset.items = {};

          // helper functions
          var levenshtein = function(str1, str2) {
            var current = [],
              prev,
              value;

            for (var i = 0; i <= str2.length; i++)
              for (var j = 0; j <= str1.length; j++) {
                if (i && j)
                  if (str1.charAt(j - 1) === str2.charAt(i - 1)) value = prev;
                  else value = Math.min(current[j], current[j - 1], prev) + 1;
                else value = i + j;

                prev = current[j];
                current[j] = value;
              }

            return current.pop();
          };

          // return an edit distance from 0 to 1
          var _distance = function(str1, str2) {
            if (str1 === null && str2 === null)
              throw "Trying to compare two null values";
            if (str1 === null || str2 === null) return 0;
            str1 = String(str1);
            str2 = String(str2);

            var distance = levenshtein(str1, str2);
            if (str1.length > str2.length) {
              return 1 - distance / str1.length;
            } else {
              return 1 - distance / str2.length;
            }
          };
          var _nonWordRe = /[^a-zA-Z0-9\u00C0-\u00FF, ]+/g;

          var _iterateGrams = function(value, gramSize) {
            gramSize = gramSize || 2;
            var simplified =
                "-" + value.toLowerCase().replace(_nonWordRe, "") + "-",
              lenDiff = gramSize - simplified.length,
              results = [];
            if (lenDiff > 0) {
              for (var i = 0; i < lenDiff; ++i) {
                simplified += "-";
              }
            }
            for (var i = 0; i < simplified.length - gramSize + 1; ++i) {
              results.push(simplified.slice(i, i + gramSize));
            }
            return results;
          };

          var _gramCounter = function(value, gramSize) {
            // return an object where key=gram, value=number of occurrences
            gramSize = gramSize || 2;
            var result = {},
              grams = _iterateGrams(value, gramSize),
              i = 0;
            for (i; i < grams.length; ++i) {
              if (grams[i] in result) {
                result[grams[i]] += 1;
              } else {
                result[grams[i]] = 1;
              }
            }
            return result;
          };

          // the main functions
          fuzzyset.get = function(value, defaultValue, minMatchScore) {
            // check for value in set, returning defaultValue or null if none found
            if (minMatchScore === undefined) {
              minMatchScore = 0.33;
            }
            var result = this._get(value, minMatchScore);
            if (!result && typeof defaultValue !== "undefined") {
              return defaultValue;
            }
            return result;
          };

          fuzzyset._get = function(value, minMatchScore) {
            var normalizedValue = this._normalizeStr(value),
              result = this.exactSet[normalizedValue];
            if (result) {
              return [[1, result]];
            }

            var results = [];
            // start with high gram size and if there are no results, go to lower gram sizes
            for (
              var gramSize = this.gramSizeUpper;
              gramSize >= this.gramSizeLower;
              --gramSize
            ) {
              results = this.__get(value, gramSize, minMatchScore);
              if (results && results.length > 0) {
                return results;
              }
            }
            return null;
          };

          fuzzyset.__get = function(value, gramSize, minMatchScore) {
            var normalizedValue = this._normalizeStr(value),
              matches = {},
              gramCounts = _gramCounter(normalizedValue, gramSize),
              items = this.items[gramSize],
              sumOfSquareGramCounts = 0,
              gram,
              gramCount,
              i,
              index,
              otherGramCount;

            for (gram in gramCounts) {
              gramCount = gramCounts[gram];
              sumOfSquareGramCounts += Math.pow(gramCount, 2);
              if (gram in this.matchDict) {
                for (i = 0; i < this.matchDict[gram].length; ++i) {
                  index = this.matchDict[gram][i][0];
                  otherGramCount = this.matchDict[gram][i][1];
                  if (index in matches) {
                    matches[index] += gramCount * otherGramCount;
                  } else {
                    matches[index] = gramCount * otherGramCount;
                  }
                }
              }
            }

            function isEmptyObject(obj) {
              for (var prop in obj) {
                if (obj.hasOwnProperty(prop)) return false;
              }
              return true;
            }

            if (isEmptyObject(matches)) {
              return null;
            }

            var vectorNormal = Math.sqrt(sumOfSquareGramCounts),
              results = [],
              matchScore;
            // build a results list of [score, str]
            for (var matchIndex in matches) {
              matchScore = matches[matchIndex];
              results.push([
                matchScore / (vectorNormal * items[matchIndex][0]),
                items[matchIndex][1]
              ]);
            }
            var sortDescending = function(a, b) {
              if (a[0] < b[0]) {
                return 1;
              } else if (a[0] > b[0]) {
                return -1;
              } else {
                return 0;
              }
            };
            results.sort(sortDescending);
            if (this.useLevenshtein) {
              var newResults = [],
                endIndex = Math.min(50, results.length);
              // truncate somewhat arbitrarily to 50
              for (var i = 0; i < endIndex; ++i) {
                newResults.push([
                  _distance(results[i][1], normalizedValue),
                  results[i][1]
                ]);
              }
              results = newResults;
              results.sort(sortDescending);
            }
            var newResults = [];
            results.forEach(
              function(scoreWordPair) {
                if (scoreWordPair[0] >= minMatchScore) {
                  newResults.push([
                    scoreWordPair[0],
                    this.exactSet[scoreWordPair[1]]
                  ]);
                }
              }.bind(this)
            );
            return newResults;
          };

          fuzzyset.add = function(value) {
            var normalizedValue = this._normalizeStr(value);
            if (normalizedValue in this.exactSet) {
              return false;
            }

            var i = this.gramSizeLower;
            for (i; i < this.gramSizeUpper + 1; ++i) {
              this._add(value, i);
            }
          };

          fuzzyset._add = function(value, gramSize) {
            var normalizedValue = this._normalizeStr(value),
              items = this.items[gramSize] || [],
              index = items.length;

            items.push(0);
            var gramCounts = _gramCounter(normalizedValue, gramSize),
              sumOfSquareGramCounts = 0,
              gram,
              gramCount;
            for (gram in gramCounts) {
              gramCount = gramCounts[gram];
              sumOfSquareGramCounts += Math.pow(gramCount, 2);
              if (gram in this.matchDict) {
                this.matchDict[gram].push([index, gramCount]);
              } else {
                this.matchDict[gram] = [[index, gramCount]];
              }
            }
            var vectorNormal = Math.sqrt(sumOfSquareGramCounts);
            items[index] = [vectorNormal, normalizedValue];
            this.items[gramSize] = items;
            this.exactSet[normalizedValue] = value;
          };

          fuzzyset._normalizeStr = function(str) {
            if (Object.prototype.toString.call(str) !== "[object String]")
              throw "Must use a string as argument to FuzzySet functions";
            return str.toLowerCase();
          };

          // return length of items in set
          fuzzyset.length = function() {
            var count = 0,
              prop;
            for (prop in this.exactSet) {
              if (this.exactSet.hasOwnProperty(prop)) {
                count += 1;
              }
            }
            return count;
          };

          // return is set is empty
          fuzzyset.isEmpty = function() {
            for (var prop in this.exactSet) {
              if (this.exactSet.hasOwnProperty(prop)) {
                return false;
              }
            }
            return true;
          };

          // return list of values loaded into set
          fuzzyset.values = function() {
            var values = [],
              prop;
            for (prop in this.exactSet) {
              if (this.exactSet.hasOwnProperty(prop)) {
                values.push(this.exactSet[prop]);
              }
            }
            return values;
          };

          // initialization
          var i = fuzzyset.gramSizeLower;
          for (i; i < fuzzyset.gramSizeUpper + 1; ++i) {
            fuzzyset.items[i] = [];
          }
          // add all the items to the set
          for (i = 0; i < arr.length; ++i) {
            fuzzyset.add(arr[i]);
          }

          return fuzzyset;
        };

        var root = this;
        // Export the fuzzyset object for **CommonJS**, with backwards-compatibility
        // for the old `require()` API. If we're not in CommonJS, add `_` to the
        // global object.
        if (typeof module !== "undefined" && module.exports) {
          module.exports = FuzzySet;
          if (root) {
            root.FuzzySet = FuzzySet;
          }
        } else {
          root.FuzzySet = FuzzySet;
        }
      })();
    </script>
    <script>
      let posts = FuzzySet();
      document.documentElement.addEventListener("keydown", () => {
        let searchElem = document.querySelector(".search");
        searchElem.focus();
        if (searchElem.value.length > 2) {
          let matches = posts.get(searchElem.value, [], 0.1).map(e => e[1]);
          for (elem of document.querySelectorAll(".post")) {
            console.log(matches);
            if (!matches.includes(elem.id)) {
              elem.classList.add("hidden");
            } else {
              elem.classList.remove("hidden");
            }
          }
        } else {
          for (elem of document.querySelectorAll(".hidden")) {
            elem.classList.remove("hidden");
          }
        }
      });
      document.documentElement.addEventListener("click", () => {
        document.querySelector(".search").value = "";
        document.querySelectorAll(".hidden").forEach(elem => {
          elem.classList.remove("hidden");
        });
      });
      window.onload = () => {
        for (elem of document.querySelectorAll(".post")) {
          posts.add(elem.id);
        }
      };
    </script>
    <div class="nav">
      <div class="back-button" onclick="window.history.back()">Back</div>
      <div class="ncontainer">
        <input
          type="text"
          class="search"
          placeholder="Start typing to search"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        />
      </div>
      <div class="right">
        <div class="tags">
          <div class="tag">test tag</div>
        </div>
        <div class="date">idk</div>
      </div>
    </div>
    <div class="content">
      {% for post in posts %}
      <div class="post" id="{{ post.name.as_str() }}">
        <div class="posttitle">
          <a href="/posts/{{ post.index }}.html">{{ post.name.as_str() }}</a>
        </div>
        <div class="postcontent">
          {% for paragraph in post.summary %}
          <p>{{ paragraph }}</p>
          {% endfor %}
        </div>
        <div class="info">
          <div class="date">{{ post.date.as_str() }}</div>
          <div class="tags">
            {% for tag in post.tags %}
            <div class="tag">{{ tag.as_str() }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </body>
</html>
